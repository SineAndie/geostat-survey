---
title: "Phase 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SimSurvey)
```

# Simulate an age-structured, spatially-correlated population

`sim_distribution()` is used to distribute a population simulated using `sim_abundance()` throughout a grid. 

- Key arguments:

1. `sim` -- A list with abundance details like produced by `sim_abundance()`
  
  - `ages`, `years` -- supply vectors of ages and years to simulate across
  - `R`, `Z`, `N0`, `growth` -- supply closures such as `sim_R()`, `sim_Z()`, `sim_N0()` and `sim_vonB()`
  
2. `grid` -- A raster object defining the survey grid, like the one produced by `make_grid()` -- sets up a depth stratified survey grid, returns a raster object with four layers: `depth`, `cell`, `division`, and `strat`; Number of strata are affected by the number of divisions (`n_div`), horizontal splits (`strat_splits`), the depth gradient (`shelf_depth`, `shelf_width`, `depth_range`), and depth breaks (`strat_breaks`)

3. `ays_covar` -- Closure for simulating age-year-space covariance, like `sim_ays_covar()` -- covarience matrix
  
4. `depth_par` -- Closure for defining relationship between abundance and depth, like `sim_parabola()`

```{r}
set.seed(431)
pop <- sim_abundance(ages = 1:20, #fish age vector
                     years = 1:20, #year vector
                     Z = sim_Z(log_mean = log(0.6), #Total mortality matrix -- rnorm
                               log_sd = 0.1,
                               phi_age = 0.9,
                               phi_year = 0.9, 
                               plot = TRUE),
                     R = sim_R(log_mean = log(1e+07), #Recruitment vector -- rnorm
                               log_sd = 0.5,
                               random_walk = TRUE, 
                               plot = TRUE),
                     N0 = sim_N0(N0 = "exp", #Starting abundance vector -- exponential Z; N0 at age 1 is R0
                                 plot = TRUE), 
                     growth = sim_vonB(Linf = 100, #abundance-at-age matrix
                                       L0 = 5, 
                                       K = 0.2, 
                                       log_sd = 0.05, 
                                       plot = TRUE,
                                       length_group = 3))  %>%
                                      
  sim_distribution(grid = make_grid(x_range = c(-140, 140), # km
                                    y_range = c(-140, 140),# km
                                    res = c(10, 10), # km
                                    shelf_depth = 200, #m
                                    shelf_width = 100, #km
                                    depth_range = c(10, 1000), #m
                                    n_div = 1, #number of division
                                    strat_breaks = seq(0, 1000, by = 40), #strata depth breaks, meter
                                    strat_splits = 2, # horizontally split strat
                                    method = "spline"), #spline, loess, linear interpolation options
                   ays_covar = sim_ays_covar(range = 300, #adding noise correlated across space, year, and age dimensions -- covariance matrix
                                             phi_age = 0.8, #strong correlation across ages
                                             phi_year = 0.1),#weak correlation across years
                   depth_par = sim_parabola(mu = 200, #defining relationship between abundance and depth, i.e., adding a parabolic depth 'preference', fish prefers occurring around 200 meters 
                                            sigma = 70))

  
```


Some graphs:

```{r}
plot_trend(pop)
```

```{r}
plot_surface(pop)
```
```{r}
library(dplyr)
xy_sim <- as_tibble(pop$grid_xy)
df_sim <- as_tibble(pop$sp_N)
```


```{r}
df_sim <- left_join(df_sim, xy_sim, by = "cell")
df_sim$logdv <- log(df_sim$N/1e+07)

library(ggplot2)

# distribution of total N of all ages in a year in a cell
df_sim %>% 
  group_by(x, y, year, cell) %>% 
  summarise(N = sum(N), .groups = "drop") %>% 
ggplot(aes(x, y, fill = log(N + 1))) +
  geom_raster() +
    facet_wrap(~year) +
  scale_fill_viridis_c()

# distribution of N of an age in all year in a cell

df_sim %>% 
  group_by(x, y, year, cell, age) %>% 
  summarise(N = sum(N), .groups = "drop") %>% 
ggplot(aes(x,y,fill=log(N/1e+07)))+
  geom_raster()+ 
    facet_wrap(~age) +
  theme_minimal() +
  scale_fill_viridis_c()+
    theme(legend.position="top",
          legend.justification="right",
          legend.direction="horizontal")

```


```{r}
# distribution of N of an age in a year in a cell (interactive plots with an Age-Year slider)

plot_distribution2 <-
function (sim, ages = 1:10, years = 1:10, type = "contour", 
    scale = "natural", ...) 
{
    age <- NULL
    xax <- list(title = "", zeroline = FALSE, showline = FALSE, showticklabels = FALSE, showgrid = FALSE, ticks = "")
    yax <- c(scaleanchor = "x", xax)
    d <- merge(sim$grid_xy, sim$sp_N[age %in% ages & year %in% years, ], by = "cell")
    if (scale == "log") 
        d$N <- log(d$N)
    
    d$ay <- paste(d$age, d$year, sep = "-")
    split_d <- split(d, d$ay)
    split_d <- lapply(split_d, function(.) {
        stats::xtabs(N ~ y + x, data = ., subset = NULL)
    })
    
    x <- sort(unique(d$x))
    y <- sort(unique(d$y))
    ay_combos <- expand.grid(age = sort(unique(d$age)), year = sort(unique(d$year)))
    ay_combos$ay <- paste(ay_combos$age, ay_combos$year, sep = "-")
    split_d <- split_d[ay_combos$ay]
    
    p <- plot_ly(x = ~x, y = ~y, ...)
          visible <- rep(TRUE, length(split_d))
          showscale <- rep(FALSE, length(split_d))
          showscale[1] <- TRUE
          steps <- list()
          
    for (i in seq_along(split_d)) {
        vis <- rep(FALSE, length(split_d))
        vis[i] <- TRUE
        p <- p %>% add_trace(type = type, 
                             z = matrix(split_d[[i]], 
                             nrow=nrow(split_d[[i]]), 
                             ncol=ncol(split_d[[i]])), 
                             visible = i == 1, 
                             showscale = vis, 
                             name = names(split_d)[i], 
                             colorbar = list(title = "N")) %>% 
            layout(xaxis = xax, yaxis = yax)
            steps[[i]] <- list(args = list(list(visible = vis, showscale = vis)), 
            method = "update", label = names(split_d)[i])
    }
    if (length(ages) > 1 | length(years) > 1) {
        p <- p %>% layout(sliders = list(list(currentvalue = list(prefix = "Age-Year: "), 
            steps = steps)))
    }
    p
}


plot_distribution2(pop, ages = 1:3, years = 1:3, type = "heatmap")

```
